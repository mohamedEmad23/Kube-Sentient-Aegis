# Prometheus configuration for AEGIS
global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'aegis-local-docker'
    environment: 'development'

# Alertmanager configuration (optional)
# alerting:
#   alertmanagers:
#     - timeout: 10s
#       api_version: v2
#       path_prefix: /
#       scheme: http
#       follow_redirects: true


# Load rules once and periodically evaluate them
rule_files:
  - /etc/prometheus/rules/*.yml


scrape_configs:
  # AEGIS Operator metrics
  - job_name: 'aegis-operator'
    static_configs:
      - targets: ['aegis-operator:8080']
        labels:
          service: 'aegis-operator'

  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # ============ Loki Metrics ============
  - job_name: 'loki'
    static_configs:
      - targets: ['loki:3100']

  # ============ Grafana Metrics ============
  - job_name: 'grafana'
    static_configs:
      - targets: ['grafana:3000']
    metrics_path: '/metrics'

  # ============ Host Machine Services ============
  # Use host.docker.internal to reach services running on your machine (outside Docker)
  # Ensure your docker-compose has extra_hosts configured.
  - job_name: 'demo-api-host'
    metrics_path: /metrics
    static_configs:
      # Replace hardcoded IP with host.docker.internal if the service runs on your machine
      - targets: ['host.docker.internal:30000']
        labels:
          env: 'host-machine'

  # ============ Optional: Node Exporter (System Metrics) ============
  # Uncomment to enable system-level metrics (requires node-exporter service in docker-compose)
  # - job_name: 'node-exporter'
  #   static_configs:
  #     - targets: ['node-exporter:9100']
  #       labels:
  #         service: 'node-exporter'
  #         instance: 'docker-host'

  # ============ Optional: cAdvisor (Container Metrics) ============
  # Uncomment to enable container-level metrics (requires cadvisor service in docker-compose)
  # - job_name: 'cadvisor'
  #   static_configs:
  #     - targets: ['cadvisor:8080']
  #       labels:
  #         service: 'cadvisor'
  #   metrics_path: '/metrics'

  # ============ Optional: Docker Service Discovery ============
  # Uncomment to enable auto-discovery of containers with prometheus.scrape=true label
  # Requires docker.sock to be mounted in prometheus container
  # - job_name: 'docker-services'
  #   docker_sd_configs:
  #     - host: unix:///var/run/docker.sock
  #   relabel_configs:
  #     # Only scrape containers with prometheus.scrape=true label
  #     - source_labels: [__meta_docker_container_label_prometheus_scrape]
  #       regex: 'true'
  #       action: keep
  #
  #     # Use custom port if specified
  #     - source_labels: [__meta_docker_container_label_prometheus_port]
  #       regex: '(.+)'
  #       target_label: __address__
  #       replacement: '$1'
  #
  #     # Use custom metrics path if specified
  #     - source_labels: [__meta_docker_container_label_prometheus_path]
  #       regex: '(.+)'
  #       target_label: __metrics_path__
  #       replacement: '$1'
  #
  #     # Add container name as label
  #     - source_labels: [__meta_docker_container_name]
  #       regex: '/(.*)'
  #       target_label: container
  #       replacement: '$1'
  #
  #     # Add docker network
  #     - source_labels: [__meta_docker_network_name]
  #       target_label: network

  # Kubernetes API server (if accessible)
  # - job_name: 'kubernetes-apiservers'
  #   kubernetes_sd_configs:
  #     - role: endpoints
  #   scheme: https
  #   tls_config:
  #     ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
  #   bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
